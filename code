#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#define MAX 100
#define MAX_ITEMS 50

// Struktur Barang konsisten dengan Admin/Customer
struct Barang {
    char kode[20];
    char nama[50];
    int harga;
    int stok;
} daftar[MAX];

int jumlah = 0;

// ================= LOAD TEXT =================
void loadDataTXT() {
    FILE *fp = fopen("barang.txt", "r");
    if(fp == NULL) return; // file belum ada, gapapa

    while(!feof(fp)){
        char line[200];
        if(fgets(line, sizeof(line), fp)){
            line[strcspn(line, "\n")] = 0; // hapus newline
            if(strlen(line) > 2){
                sscanf(line, "%[^|]|%[^|]|%d|%d", 
                    daftar[jumlah].kode, daftar[jumlah].nama,
                    &daftar[jumlah].harga, &daftar[jumlah].stok);
                jumlah++;
            }
        }
    }
    fclose(fp);
}

// Cek kode barang unik
int kodeAda(char kode[]) {
    for(int i = 0; i < jumlah; i++){
        if(strcmp(daftar[i].kode, kode) == 0) return 1;
    }
    return 0;
}

void tambahBarang() {
    char kode[20];
    printf("Masukkan kode barang : ");
    scanf("%s", kode);

    if(kodeAda(kode)){
        printf("Kode barang sudah ada!\n");
        return;
    }

    strcpy(daftar[jumlah].kode, kode);
    printf("Masukkan nama barang : ");
    scanf("%s", daftar[jumlah].nama);
    printf("Masukkan harga       : ");
    scanf("%d", &daftar[jumlah].harga);
    printf("Masukkan stok awal   : ");
    scanf("%d", &daftar[jumlah].stok);

    jumlah++;
    printf("Barang berhasil ditambah!\n");
}

void tampilBarang() {
    printf("\n=== DATA BARANG ===\n");
    for(int i=0;i<jumlah;i++){
        printf("%d. %s | %s | %d | stok: %d\n", i+1, daftar[i].kode, daftar[i].nama, daftar[i].harga, daftar[i].stok);
    }
}

void ubahBarang() {
    char kode[20];
    printf("Masukkan kode barang yang mau diubah: ");
    scanf("%s", kode);

    for(int i=0;i<jumlah;i++){
        if(strcmp(daftar[i].kode, kode) == 0){
            printf("Nama baru  : ");
            scanf("%s", daftar[i].nama);
            printf("Harga baru : ");
            scanf("%d", &daftar[i].harga);
            printf("Stok baru  : ");
            scanf("%d", &daftar[i].stok);
            printf("Barang berhasil diubah!\n");
            return;
        }
    }
    printf("Barang tidak ditemukan!\n");
}

void hapusBarang() {
    char kode[20];
    printf("Masukkan kode barang yang mau dihapus: ");
    scanf("%s", kode);

    for(int i=0;i<jumlah;i++){
        if(strcmp(daftar[i].kode, kode) == 0){
            for(int j=i; j < jumlah-1; j++){
                daftar[j] = daftar[j+1];
            }
            jumlah--;
            printf("Barang berhasil dihapus!\n");
            return;
        }
    }
    printf("Barang tidak ditemukan!\n");
}

// Struktur Transaksi
struct Transaksi {
    char kodeBarang[20];
    char namaBarang[50];
    int jumlahBeli;
    int hargaSatuan;
    int subTotal;
};

// ================= Kurangi Stok =================
void kurangiStock(const struct Transaksi keranjang[], int jumlahItem) {
    printf("\n--- Kurangi Stok ---\n");
    for (int i = 0; i < jumlahItem; i++) {
        char *kode = keranjang[i].kodeBarang;
        int jumlahBeli = keranjang[i].jumlahBeli;

        for (int j = 0; j < jumlah; j++) {
            if (strcmp(daftar[j].kode, kode) == 0) {
                daftar[j].stok -= jumlahBeli;
                printf("Stok %s dikurangi %d. Sisa: %d\n",
                       daftar[j].nama, jumlahBeli, daftar[j].stok);
                break;
            }
        }
    }
}

// ================= Cetak Struk =================
void cetakStruk(const struct Transaksi keranjang[], int jumlahItem,
                double totalHarga, double diskon, double totalAkhir, int isMember) {
    printf("\n        STRUK TRANSAKSI\n");
    printf("==================================\n");
    printf("STATUS: %s\n", isMember ? "Member" : "Non-Member");
    printf("----------------------------------\n");

    for (int i = 0; i < jumlahItem; i++) {
        printf("%d. %s\n", i + 1, keranjang[i].namaBarang);
        printf("   %d x %d \t\tRp %d\n",
               keranjang[i].hargaSatuan,
               keranjang[i].jumlahBeli,
               keranjang[i].subTotal);
    }

    printf("----------------------------------\n");
    printf("Total Harga Awal:\tRp %.0f\n", totalHarga);
    printf("Diskon:\t\t\tRp -%.0f\n", diskon);
    printf("TOTAL AKHIR:\t\tRp %.0f\n", totalAkhir);
    printf("==================================\n");

    // Simpan ke file
    FILE *fp = fopen("struk.dat", "w");
    if (fp != NULL) {
        fprintf(fp, "STATUS: %s\n", isMember ? "Member" : "Non-Member");
        for (int i = 0; i < jumlahItem; i++) {
            fprintf(fp, "%s x%d = Rp %d\n",
                    keranjang[i].namaBarang,
                    keranjang[i].jumlahBeli,
                    keranjang[i].subTotal);
        }
        fprintf(fp, "Total: Rp %.0f\nDiskon: Rp %.0f\nTOTAL BAYAR: Rp %.0f\n",
                totalHarga, diskon, totalAkhir);
        fclose(fp);
    }
}

// ================= Diskon =================
double hitungDiskon(double totalHarga, int member) {
    if (member && totalHarga >= 300000) return totalHarga * 0.30;
    else if (member && totalHarga >= 150000) return totalHarga * 0.20;
    else if (!member && totalHarga >= 200000) return totalHarga * 0.15;
    else if (!member && totalHarga >= 150000) return totalHarga * 0.10;
    return 0;
}

// ================= Cari Barang =================
int cariBarang(const char *kode) {
    for (int i = 0; i < jumlah; i++) {
        if (strcmp(daftar[i].kode, kode) == 0) {
            return i;
        }
    }
    return -1;
}

// ================= Proses Transaksi =================
void prosesTransaksi() {
    struct Transaksi keranjang[MAX_ITEMS];
    int jumlahItem = 0;
    double totalHarga = 0.0;
    char kodeInput[20];

    printf("\n--- Mulai Proses Transaksi ---\n");
    printf("Ketik 'SELESAI' untuk mengakhiri.\n");

    while (jumlahItem < MAX_ITEMS) {
        printf("\nMasukkan Kode Barang (atau SELESAI): ");
        scanf("%s", kodeInput);

        if (strcmp(kodeInput, "SELESAI") == 0) break;

        int idx = cariBarang(kodeInput);
        if (idx == -1) {
            printf("[ERROR] Kode barang tidak ditemukan.\n");
            continue;
        }

        int jumlahBeli;
        printf("Jumlah beli (%s, stok %d): ",
               daftar[idx].nama, daftar[idx].stok);
        scanf("%d", &jumlahBeli);

        if (jumlahBeli <= 0 || jumlahBeli > daftar[idx].stok) {
            printf("[ERROR] Stok tidak cukup atau jumlah tidak valid.\n");
            continue;
        }

        keranjang[jumlahItem].jumlahBeli = jumlahBeli;
        strcpy(keranjang[jumlahItem].kodeBarang, daftar[idx].kode);
        strcpy(keranjang[jumlahItem].namaBarang, daftar[idx].nama);
        keranjang[jumlahItem].hargaSatuan = daftar[idx].harga;
        keranjang[jumlahItem].subTotal = jumlahBeli * daftar[idx].harga;

        totalHarga += keranjang[jumlahItem].subTotal;
        daftar[idx].stok -= jumlahBeli;
        jumlahItem++;

        printf("Item ditambahkan! Total sementara: Rp %.0f\n", totalHarga);
    }

    if (jumlahItem == 0) {
        printf("\nTransaksi dibatalkan. Tidak ada item.\n");
        return;
    }

    int isMember;
    printf("\nApakah pelanggan member? (1=Ya, 0=Tidak): ");
    scanf("%d", &isMember);

    double diskon = hitungDiskon(totalHarga, isMember);
    double totalAkhir = totalHarga - diskon;

    cetakStruk(keranjang, jumlahItem, totalHarga, diskon, totalAkhir, isMember);
}

//////////////
/*custmer*/


#define MAX 100

extern struct Barang {
    char kode[20];
    char nama[50];
    int harga;
    int stok;
} daftar[MAX];

extern int jumlah;

// MENAMPILKAN SEMUA PRODUK
void customer_tampilSemua() {
    printf("\n=== SEMUA PRODUK ===\n");
    for(int i = 0; i < jumlah; i++) {
        printf("%d. %s | %s | Rp %d | Stok %d\n",
            i+1, daftar[i].kode, daftar[i].nama,
            daftar[i].harga, daftar[i].stok);
    }
}

// URUTKAN HARGA
void customer_urutHarga() {
    struct Barang temp;
    for(int i=0; i<jumlah-1; i++){
        for(int j=i+1; j<jumlah; j++){
            if(daftar[i].harga > daftar[j].harga){
                temp = daftar[i];
                daftar[i] = daftar[j];
                daftar[j] = temp;
            }
        }
    }

    printf("\nProduk sudah diurutkan berdasarkan harga termurah.\n");
    customer_tampilSemua();
}

// URUTKAN STOK
void customer_urutStok() {
    struct Barang temp;
    for(int i=0; i<jumlah-1; i++){
        for(int j=i+1; j<jumlah; j++){
            if(daftar[i].stok > daftar[j].stok){
                temp = daftar[i];
                daftar[i] = daftar[j];
                daftar[j] = temp;
            }
        }
    }

    printf("\nProduk diurutkan berdasarkan stok terkecil.\n");
    customer_tampilSemua();
}

// CARI BERDASARKAN NAMA
void customer_cariNama() {
    char cari[50];
    printf("Masukkan nama produk: ");
    scanf("%s", cari);

    printf("\n=== HASIL PENCARIAN ===\n");
    int found = 0;

    for(int i = 0; i < jumlah; i++){
        if(strstr(daftar[i].nama, cari)){
            printf("%s | %s | %d | stok %d\n",
                daftar[i].kode, daftar[i].nama,
                daftar[i].harga, daftar[i].stok);
            found = 1;
        }
    }

    if(!found) printf("Produk tidak ditemukan.\n");
}

// CARI BERDASARKAN KODE
void customer_cariKode() {
    char kode[20];
    printf("Masukkan kode produk: ");
    scanf("%s", kode);

    for(int i=0; i<jumlah; i++){
        if(strcmp(daftar[i].kode, kode)==0){
            printf("\nDitemukan: %s | %s | Rp %d | Stok %d\n",
                daftar[i].kode, daftar[i].nama,
                daftar[i].harga, daftar[i].stok);
            return;
        }
    }
    printf("Kode produk tidak ditemukan.\n");
}

// MENU CUSTOMER
void menuCustomer() {
    int pilih;

    do{
        printf("\n=== MENU CUSTOMER ===\n");
        printf("1. Tampilkan semua produk\n");
        printf("2. Urutkan produk berdasarkan harga\n");
        printf("3. Urutkan produk berdasarkan stok\n");
        printf("4. Cari produk berdasarkan nama\n");
        printf("5. Cari produk berdasarkan kode\n");
        printf("0. Kembali ke menu utama\n");
        printf("Pilih: ");
        scanf("%d", &pilih);

        switch(pilih){
            case 1: customer_tampilSemua(); break;
            case 2: customer_urutHarga(); break;
            case 3: customer_urutStok(); break;
            case 4: customer_cariNama(); break;
            case 5: customer_cariKode(); break;
            case 0: printf("Kembali ke menu utama...\n"); break;
            default: printf("Pilihan tidak valid.\n");
        }

    } while(pilih != 0);
}

// ================= Main =================
int main(){
    loadDataTXT();
    int pilih;

    do {
        printf("\n=== MENU ADMIN ===\n");
        printf("1. Tambah Barang\n");
        printf("2. Ubah Barang\n");
        printf("3. Hapus Barang\n");
        printf("4. Tampil Barang\n");
        printf("5. Simpan Data\n");
        printf("0. Keluar\n");
        printf("Pilih: ");
        scanf("%d", &pilih);

        switch(pilih){
            case 1: tambahBarang(); break;
            case 2: ubahBarang(); break;
            case 3: hapusBarang(); break;
            case 4: tampilBarang(); break;
            case 5: simpanDataTXT(); printf("Data disimpan ke barang.txt\n"); break;
            case 0: simpanDataTXT(); printf("Keluar...\n"); break;
            default: printf("Pilihan salah!\n");
        }
    } while(pilih != 0);

    return 0;
}
